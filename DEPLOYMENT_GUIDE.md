# Guide de D√©ploiement - Mami-Shop E-Commerce

## üìã Table des mati√®res

1. [Pr√©requis](#pr√©requis)
2. [Configuration Supabase](#configuration-supabase)
3. [Configuration PayTech](#configuration-paytech)
4. [Variables d'environnement](#variables-denvironnement)
5. [D√©ploiement sur Vercel](#d√©ploiement-sur-vercel)
6. [Configuration post-d√©ploiement](#configuration-post-d√©ploiement)
7. [Tests](#tests)
8. [Maintenance](#maintenance)

---

## üéØ Pr√©requis

- [x] Compte Supabase (d√©j√† configur√©)
- [x] Compte Vercel (d√©j√† configur√© avec auto-d√©ploiement depuis GitHub)
- [ ] Compte PayTech pour les paiements mobiles
- [ ] Compte Resend pour les emails (d√©j√† configur√©)
- [x] Repository GitHub

---

## üóÑÔ∏è Configuration Supabase

### ‚úÖ D√©j√† configur√©

Votre base de donn√©es Supabase est d√©j√† op√©rationnelle avec :

- **Database URL (Pooled)**: Pour l'application Next.js
- **Direct URL**: Pour les migrations Prisma
- **Storage**: Pour les images des produits

### V√©rification de la configuration

```bash
# Tester la connexion √† la base de donn√©es
npm run db:generate
npm run db:studio
```

---

## üí≥ Configuration PayTech

### √âtape 1: Cr√©er un compte PayTech

1. Visitez [https://paytech.sn](https://paytech.sn)
2. Cr√©ez un compte marchand
3. Compl√©tez la v√©rification KYC (Know Your Customer)

### √âtape 2: R√©cup√©rer les cl√©s API

1. Connectez-vous √† votre dashboard PayTech
2. Allez dans **Param√®tres > API**
3. R√©cup√©rez vos cl√©s :
   - `API_KEY` (cl√© publique)
   - `API_SECRET` (cl√© secr√®te)

### √âtape 3: Configurer les webhooks PayTech

Dans le dashboard PayTech, configurez l'URL IPN (Instant Payment Notification) :

- **URL IPN de test**: `https://votre-app.vercel.app/api/checkout/paytech-webhook`
- **URL IPN de production**: `https://mami-shop.com/api/checkout/paytech-webhook`

### Modes de paiement support√©s

PayTech supporte les m√©thodes suivantes au S√©n√©gal :
- ‚úÖ Wave
- ‚úÖ Orange Money
- ‚úÖ Free Money
- ‚úÖ E-Money (Wizall)
- ‚úÖ Cartes bancaires (Visa, Mastercard)

---

## üîê Variables d'environnement

### Sur Vercel

1. Allez dans votre projet Vercel
2. **Settings > Environment Variables**
3. Ajoutez les variables suivantes :

#### Base de donn√©es (Supabase)

```bash
# Connexion pool√©e pour l'app
DATABASE_URL="postgresql://postgres.fjarsnhfbdmlqgyfjzvt:Mamita-2025%23@aws-1-eu-north-1.pooler.supabase.com:6543/postgres?pgbouncer=true&sslmode=require"

# Connexion directe pour Prisma Migrate
DIRECT_URL="postgresql://postgres:Mamita-2025%23@db.fjarsnhfbdmlqgyfjzvt.supabase.co:5432/postgres?sslmode=require"
```

#### Supabase

```bash
NEXT_PUBLIC_SUPABASE_URL=https://fjarsnhfbdmlqgyfjzvt.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqYXJzbmhmYmRtbHFneWZqenZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MzM2OTksImV4cCI6MjA3MTMwOTY5OX0.Hk09T1oz_w8MvCud3Vi22Lfyv7Z8MKlIqGDZVip0nMo
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqYXJzbmhmYmRtbHFneWZqenZ0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTczMzY5OSwiZXhwIjoyMDcxMzA5Njk5fQ.k380ej2oDPfSaMgFJ6073C2LPofD2uc2cOvXjz8QS4E
```

#### Auth.js (NextAuth v5)

```bash
# G√©n√©rer un nouveau secret avec: openssl rand -hex 32
NEXTAUTH_SECRET="9128bac5a32920b10463076a6da2dcca1ab97c734e156be8b05def9472922d43"

# URL de production (√† mettre √† jour avec votre domaine)
NEXTAUTH_URL=https://votre-app.vercel.app
```

#### Resend (Emails)

```bash
RESEND_API_KEY=re_aCVhDxrR_EVwjp8sEeDwNxcszJuMJcKKt
```

#### PayTech (Paiements)

```bash
# √Ä CONFIGURER APR√àS CR√âATION DU COMPTE PAYTECH
PAYTECH_API_KEY=votre_api_key_paytech
PAYTECH_SECRET_KEY=votre_secret_key_paytech

# Mode: "test" pour le d√©veloppement, "prod" pour la production
PAYTECH_ENV=test

# URLs de callback (√† mettre √† jour avec votre domaine)
NEXT_PUBLIC_PAYTECH_SUCCESS_URL=https://votre-app.vercel.app/checkout/success
NEXT_PUBLIC_PAYTECH_CANCEL_URL=https://votre-app.vercel.app/checkout/cancel
NEXT_PUBLIC_PAYTECH_IPN_URL=https://votre-app.vercel.app/api/checkout/paytech-webhook
```

### Important

- ‚úÖ Toutes les variables pr√©fix√©es `NEXT_PUBLIC_` sont expos√©es au client
- ‚ö†Ô∏è Les autres variables sont uniquement accessibles c√¥t√© serveur
- üîí Ne JAMAIS commiter les valeurs r√©elles dans Git

---

## üöÄ D√©ploiement sur Vercel

### D√©ploiement automatique (d√©j√† configur√©)

Votre projet est d√©j√† configur√© pour le d√©ploiement automatique :

1. **Push sur GitHub** ‚Üí D√©ploiement automatique sur Vercel
2. **Branch principale** ‚Üí Production
3. **Autres branches** ‚Üí Preview deployments

### Premi√®re migration de la base de donn√©es

Apr√®s le premier d√©ploiement, vous devez ex√©cuter les migrations :

```bash
# Option 1: Via Vercel CLI
vercel env pull .env.production
npx prisma migrate deploy
npx prisma db seed

# Option 2: Via le projet d√©ploy√© (ajouter une route temporaire)
# Cr√©er app/api/migrate/route.ts pour migration manuelle
```

### Configuration Build sur Vercel

Vercel utilise d√©j√† la configuration dans `vercel.json` :

```json
{
  "installCommand": "npm install --legacy-peer-deps",
  "buildCommand": "npm run build"
}
```

Le script `prebuild` dans `package.json` g√©n√®re automatiquement le client Prisma :

```json
"prebuild": "prisma generate"
```

---

## ‚öôÔ∏è Configuration post-d√©ploiement

### 1. Configurer le domaine custom (optionnel)

1. Allez dans **Settings > Domains** sur Vercel
2. Ajoutez votre domaine personnalis√© (ex: `mami-shop.com`)
3. Configurez les DNS selon les instructions Vercel
4. Mettez √† jour `NEXTAUTH_URL` avec le nouveau domaine

### 2. Tester le webhook PayTech

PayTech doit pouvoir acc√©der √† votre webhook. Testez avec :

```bash
curl -X POST https://votre-app.vercel.app/api/checkout/paytech-webhook \
  -H "Content-Type: application/json" \
  -H "paytech-signature: test_signature" \
  -d '{
    "type_event": "payment_complete",
    "ref_command": "TEST-123",
    "item_name": "Test",
    "item_price": "5000",
    "devise": "XOF",
    "payment_method": "wave",
    "payment_ref": "PAY-123"
  }'
```

### 3. Cr√©er un utilisateur admin

Connectez-vous √† Prisma Studio en production :

```bash
# Via Supabase SQL Editor
# Ou cr√©er une route admin temporaire pour le premier setup
```

### 4. Importer les produits

Utilisez l'interface admin pour importer vos produits :

1. Connectez-vous √† `/admin`
2. Allez dans **Products > Import**
3. Uploadez votre fichier CSV

---

## üß™ Tests

### Test du flux de paiement complet

1. **Ajouter un produit au panier**
   - Allez sur `/catalog`
   - Ajoutez un produit au panier

2. **Passer une commande**
   - Allez dans `/cart`
   - Cliquez sur "Commander"
   - Remplissez le formulaire `/checkout`

3. **Tester le paiement**
   - Mode test PayTech : utilisez les coordonn√©es de test
   - V√©rifiez la redirection vers `/checkout/success`

4. **V√©rifier la commande**
   - Allez dans `/admin/orders`
   - V√©rifiez que la commande appara√Æt avec le statut `PAID`

### Test des webhooks PayTech

1. Effectuez un paiement test
2. V√©rifiez les logs Vercel :
   ```bash
   vercel logs --follow
   ```
3. Confirmez que le webhook IPN est re√ßu et trait√©

### Test mobile

1. **Chrome DevTools**
   - F12 > Toggle device toolbar
   - Testez sur iPhone SE, iPhone 12 Pro, Pixel 5

2. **Tests r√©els**
   - Testez sur de vrais appareils Android et iOS
   - V√©rifiez Wave et Orange Money sur t√©l√©phone

---

## üîß Maintenance

### Monitoring

1. **Vercel Analytics**
   - Activez dans **Settings > Analytics**
   - Suivez les performances et erreurs

2. **Logs**
   ```bash
   # Voir les logs en temps r√©el
   vercel logs --follow
   
   # Logs d'une fonction sp√©cifique
   vercel logs --function api/checkout/paytech-webhook
   ```

3. **Supabase Dashboard**
   - Surveillez l'utilisation de la base de donn√©es
   - V√©rifiez les requ√™tes lentes dans **Database > Query Performance**

### Sauvegardes

1. **Base de donn√©es**
   - Supabase fait des backups automatiques quotidiens
   - Pour backup manuel : **Database > Backups**

2. **Images**
   - Les images sont stock√©es sur Supabase Storage
   - Configurez des backups dans **Storage > Settings**

### Mises √† jour

```bash
# Mettre √† jour les d√©pendances
npm update

# V√©rifier les vuln√©rabilit√©s
npm audit

# Fixer les vuln√©rabilit√©s
npm audit fix
```

### Migrations de sch√©ma

```bash
# Cr√©er une nouvelle migration
npx prisma migrate dev --name description_du_changement

# Appliquer en production
npx prisma migrate deploy
```

---

## üìä Checklist de d√©ploiement

### Avant le premier d√©ploiement

- [x] Base de donn√©es Supabase configur√©e
- [x] Repository GitHub connect√© √† Vercel
- [ ] Compte PayTech cr√©√© et v√©rifi√©
- [ ] Variables d'environnement configur√©es sur Vercel
- [x] Cl√©s API Resend configur√©es
- [ ] Domaine personnalis√© configur√© (optionnel)

### Apr√®s le premier d√©ploiement

- [ ] Migrations Prisma ex√©cut√©es
- [ ] Donn√©es seed import√©es
- [ ] Utilisateur admin cr√©√©
- [ ] Webhook PayTech test√©
- [ ] Flux de paiement complet test√©
- [ ] Tests sur mobile (iOS et Android)
- [ ] Analytics activ√©es
- [ ] Monitoring configur√©

### En production

- [ ] Mode PayTech pass√© en `prod`
- [ ] HTTPS v√©rifi√© (automatique avec Vercel)
- [ ] CSP headers configur√©s
- [ ] Rate limiting activ√©
- [ ] Emails de confirmation fonctionnels
- [ ] Notifications admin configur√©es

---

## üÜò D√©pannage

### Erreur de connexion Prisma

```bash
# V√©rifier les variables DATABASE_URL et DIRECT_URL
# R√©g√©n√©rer le client Prisma
npx prisma generate
```

### Webhook PayTech non re√ßu

1. V√©rifier l'URL IPN dans le dashboard PayTech
2. V√©rifier les logs Vercel
3. Tester avec curl
4. V√©rifier la signature

### Images non charg√©es

1. V√©rifier que l'URL Supabase est bien dans `next.config.ts`
2. V√©rifier les permissions dans Supabase Storage

---

## üìû Support

- **PayTech**: [support@paytech.sn](mailto:support@paytech.sn)
- **Supabase**: [Support](https://supabase.com/support)
- **Vercel**: [Support](https://vercel.com/support)

---

## üéâ F√©licitations !

Votre application e-commerce Mami-Shop est maintenant d√©ploy√©e et pr√™te pour les paiements mobiles au S√©n√©gal ! üá∏üá≥

**Prochaines √©tapes recommand√©es :**

1. Configurer Google Analytics ou Matomo
2. Ajouter des tests automatis√©s
3. Configurer un monitoring avanc√© (Sentry, LogRocket)
4. Optimiser le SEO
5. Mettre en place une strat√©gie de contenu

Bon commerce ! üöÄ
